#!/bin/sh
#
prog=sminstall
usage=$prog
#
#	Install the slowmovie software on Raspberry Pi running Debian,
#	FreeBSD machines, and MacOS.

BIN=$HOME/bin

if [ ! -d $BIN ]
then
	mkdir -p ${BIN}	|| exit 1
fi

for p in ffmpeg imagemagick w9wm xterm
do
	if [ ! -n "`which $p`" ]
	then
		case `uname` in
		Linux)
			sudo apt-get install -y $p	|| exit 10
			;;
		FreeBSD)
			sudo sudo pkg install -y $p	|| exit 11
			;;
		Darwin)
			# stub
			;;
		esac
	fi
done

progs="smadd smupdate smplay smindex smbanner smstart \
	sminstall smsetup smcreate smdefs"

for i in $progs
do
	if [ ! -s $BIN/$i -o $i -nt $BIN/$i ]
	then
		cp $i $BIN/$i	|| exit 2
	fi
done

case `uname` in 
FreeBSD)	splitter=cv;;
Linux)		splitter=av;;
##Darwin)
*)
	splitter=cv
esac

(cd src;
	make ${splitter}_install)

# Set up .xinitrc to start up things

if ! egrep 'smstart' $HOME/.xinitrc >/dev/null
then
	cat <<!EOF >$HOME/.xinitrc
#!/bin/sh

xsetroot -solid darkblue -cursor_name top_left_arrow
xset s off -dpms

smstart -r -a -n &

exec w9wm -term xterm
!EOF
fi

# add x start to .profile

if ! grep startx $HOME/.profile >/dev/null
then
	cat <<!EOF >>.profile

export  PATH=$PATH:$HOME/bin

case `tty` in
/dev/tty1)      startx -- -nocursor;;
esac
!EOF
fi

. smdefs	|| exit 99

if [ ! -s $LOG ]
then
	sudo cp /dev/null $LOG
	user=`id -u -n`
	sudo chown $user $LOG
	chmod 644 $LOG
fi

mkdir -p $LOCAL_MOVIE_CATALOG	|| exit 3
