#!/bin/sh
#
prog=addmovie
usage="$prog [-s spf] [-f first_frame] [-n frame_count] title i1 i2 ..."
#
#	Add a movie named "name" to our catalog.  It consists of one or
#	more video files found relative to the current directory, and
#	concatentated together.
#
#	files, each of which may have additional information in a .data file.
#	All are processed into the catalog directory, if forced or the catalog
#	entry is missing or older.
#
#	-f	force rebuild of given movies

WEB_CATALOG=/r/media/slowmovies/catalog

WRKDIR=${WRKDIR:-${TMPDIR}/${prog}}
mkdir -p $WRKDIR        || exit 100
trap "rm -rf $WRKDIR" EXIT

spf=10
start=0
count=all

while [ $# -gt 0 ]
do
	case "$1" in
	-s)	shift; spf=$1; shift;;
	-f)	shift; start=$1; shift;;
	-n)	shift; count=$1; shift;;
	-*)	echo "$usage" 1>&2
		exit 1;;
	*)	break
	esac
done

if [ $# -lt 2 ]
then
	echo "$usage" 1>&2
	exit 1
fi

title="$1";	shift

inputlist=""
while [ $# -gt 0 ]
do
	inputlist="$inputlist -i $1"
done

cataloged_video="$WEB_CATALOG/$title"
rm -f $cataloged_video/info

ffmpeg $inputlist -q:v 2 -v 16 -huffman optimal "$cataloged_video/video.mp4"

# generate executable shell variables for relevant information

cat <<!EOF >$cataloged_video/info
title='$title'
spf=$spf
start=$start
count=$count
updated=`date +%s`
!EOF
chmod +x $cataloged_video/info

# generate new catalog index
(cd $WEB_CATALOG;
	for i in *
	do
		. info
		echo "$title	$updated"
	done
) >../index
