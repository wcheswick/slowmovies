#!/bin/sh
#
prog=playsm
usage="$prog m1 m2 ..."
#
#	Play a slow movie on the current machine.  There are a few styles:
#
#	desktop	desktop backround (x root, or equivalent)
#	full	full screen
#
#	We pick the best we can


export PATH=$PATH:$HOME/bin

. slowdefs

case `uname` in
Linux)
	TMPDIR=${TMPDIR:-/var/tmp}
	style=desktop
	;;
Darwin)
	TMPDIR=${TMPDIR:-/var/tmp}
	style=appledesktop
	;;
FreeBSD)
	TMPDIR=${TMPDIR:-/var/tmp}
	style=desktop
	;;
*)		# just guessing here
	TMPDIR=${TMPDIR:-/var/tmp}
	style=desktop
esac

WRKDIR=$TMPDIR/slowmovies
rm -rf $WRKDIR 2>/dev/null

cd $MOVIE_CATALOG

while [ $# -gt 0 ]
do
	movie="$1"

	if [ ! -d "$movie" ]
	then
		echo "$prog: $movie	missing" 1>&2
		continue
	fi

	. "$movie"/info

	if [ ! -n "$spf" ]
	then
		spf=10		# default six frames per minute
	fi

	echo "`date +%'b %e %H:%m:%S'`	$spf spf	$title" | tee -a $LOG 

	mkdir -p $WRKDIR 2>/dev/null

	nice ffmpeg -i "$movie"/video.* -q:v 2 -v 16 \
		-vf "drawtext=text='Through the Adirondacks': \
			fontcolor=white: fontsize=14: \
			box=1: boxcolor=black@0.5: \
			fix_bounds=1: \
			boxborderw=5: x=5: y=h-18:, \
		drawtext=text='frame %{n}': \
			fontcolor=white: fontsize=12: \
			box=1: boxcolor=black@0.5: \
			fix_bounds=1: \
			boxborderw=5: x=w-tw-5: y=h-14:" \
		$WRKDIR/frame%09d.jpeg &

	for i in 1 2 3 4 5 6 7 8 9
	do
		fn=`cd $WRKDIR; ls | sed 1q`
		case "$fn" in
		"")	sleep 1
			continue;;
		*)
			break
		esac
	done

	if [ ! -n $WRKDIR/$fn ]
	then
		echo "$prog:	apparent ffmpeg problem, aborting" 1>&2
		exit 2
	fi

	while [ -n "$WRKDIR/$fn" ]
	do
		case $style in
		desktop)
			xloadimage -fullscreen -onroot -quiet \
				-border black $WRKDIR/$fn
			;;
		appledesktop)
osascript <<!EOF
tell application "System Events"
        tell (every desktop)
                set picture rotation to 0
                set picture to POSIX file "$fn"
        end tell
end tell
!EOF
			;;
		full)
			xloadimage -fullscreen -border black $fn
			;;
		esac

		sleep $spf

		rm -f "$WRKDIR/$fn"
		fn=`cd $WRKDIR; ls | sed 1q`
	done
	wait

	rm -rf $WRKDIR

	shift
done
